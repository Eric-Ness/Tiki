#!/bin/bash
set -e

echo "Pre-ship hook: Updating version for issue #$TIKI_ISSUE_NUMBER"

# Get current version from version.json
CURRENT=$(node -p "require('./version.json').version")
echo "Current version: $CURRENT"

# Parse version components
IFS='.' read -r major minor patch <<< "$CURRENT"

# Increment patch version
NEW_VERSION="$major.$minor.$((patch + 1))"
echo "New version: $NEW_VERSION"

# Get today's date
TODAY=$(date +%Y-%m-%d)

# Update version.json - version, releaseDate, and add changelog entry
node -e "
const fs = require('fs');
const data = JSON.parse(fs.readFileSync('version.json', 'utf8'));

// Update version and date
data.version = '$NEW_VERSION';
data.releaseDate = '$TODAY';

// Add changelog entry for this issue if not already present
const issueNumber = '$TIKI_ISSUE_NUMBER';
const issueTitle = process.env.TIKI_ISSUE_TITLE || 'Unknown';

// Check if this version already has an entry
const existingEntry = data.changelog.find(e => e.version === '$NEW_VERSION');
if (!existingEntry) {
  // Add new changelog entry at the beginning
  data.changelog.unshift({
    version: '$NEW_VERSION',
    date: '$TODAY',
    changes: [
      'Issue #' + issueNumber + ': ' + issueTitle
    ]
  });
  console.log('Added changelog entry for issue #' + issueNumber);
} else {
  // Append to existing entry if issue not already listed
  const issueRef = 'Issue #' + issueNumber;
  if (!existingEntry.changes.some(c => c.startsWith(issueRef))) {
    existingEntry.changes.push(issueRef + ': ' + issueTitle);
    console.log('Appended to existing changelog entry');
  }
}

fs.writeFileSync('version.json', JSON.stringify(data, null, 2) + '\n');
console.log('Updated version.json');
"

# Update README.md version
sed -i "s/\*\*Version:\*\* [0-9]*\.[0-9]*\.[0-9]*/\*\*Version:\*\* $NEW_VERSION/" README.md
echo "Updated README.md"

# Stage the updated files
git add version.json README.md
echo "Staged version.json and README.md"

echo "Version bumped: $CURRENT -> $NEW_VERSION"
