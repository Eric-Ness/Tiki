---
type: prompt
name: tiki:map-codebase
description: Analyze codebase and generate STACK.md and CONCERNS.md. Use when starting with a new codebase or refreshing documentation.
allowed-tools: Read, Write, Bash, Glob, Grep, Task
argument-hint: [--stack-only] [--concerns-only] [--update-claude]
---

# Map Codebase

Analyze an existing codebase to generate documentation about the tech stack and known concerns.

## Usage

```
/tiki:map-codebase
/tiki:map-codebase --stack-only
/tiki:map-codebase --concerns-only
/tiki:map-codebase --update-claude
```

## Instructions

### Step 1: Analyze Project Structure

Start by understanding the project layout:

```bash
# Get directory structure (first 3 levels)
find . -type d -maxdepth 3 | grep -v node_modules | grep -v .git | head -50
```

Use Glob to find key files:

```
# Package files
Glob: **/package.json, **/requirements.txt, **/Cargo.toml, **/go.mod, **/*.csproj

# Config files
Glob: **/.env.example, **/tsconfig.json, **/webpack.config.*, **/vite.config.*

# Entry points
Glob: **/main.*, **/index.*, **/app.*, **/server.*
```

### Step 2: Detect Languages and Frameworks

#### JavaScript/TypeScript

```bash
# Check package.json for dependencies
cat package.json | grep -A 50 '"dependencies"' | head -60
```

Look for:
- React, Vue, Angular, Svelte (frontend)
- Express, Fastify, NestJS, Hono (backend)
- Jest, Vitest, Mocha (testing)
- Prisma, TypeORM, Drizzle (ORM)

#### Python

```bash
# Check requirements.txt or pyproject.toml
cat requirements.txt 2>/dev/null || cat pyproject.toml 2>/dev/null
```

Look for:
- Django, Flask, FastAPI (web)
- SQLAlchemy, Django ORM (database)
- pytest, unittest (testing)

#### Other Languages

Check for:
- `Cargo.toml` → Rust
- `go.mod` → Go
- `*.csproj` → C#/.NET
- `Gemfile` → Ruby

### Step 3: Identify Patterns

Use Grep to find common patterns:

```
# API patterns
Grep: "app\.(get|post|put|delete|patch)\(" --type ts
Grep: "@(Get|Post|Put|Delete|Patch)\(" --type ts

# Database patterns
Grep: "prisma\." --type ts
Grep: "mongoose\." --type ts

# Testing patterns
Grep: "(describe|it|test)\(" --type ts

# State management
Grep: "(useContext|useReducer|createStore|createSlice)" --type ts
```

### Step 4: Generate STACK.md

Create `STACK.md` in the project root:

```markdown
# Tech Stack

> Auto-generated by Tiki on 2026-01-10. Last updated: 2026-01-10.

## Languages

| Language | Version | Usage |
|----------|---------|-------|
| TypeScript | 5.3 | Primary language |
| JavaScript | ES2022 | Build scripts |

## Frontend

| Technology | Version | Purpose |
|------------|---------|---------|
| React | 18.2 | UI framework |
| TailwindCSS | 3.4 | Styling |
| React Router | 6.x | Routing |
| React Query | 5.x | Data fetching |

## Backend

| Technology | Version | Purpose |
|------------|---------|---------|
| Node.js | 20.x | Runtime |
| Express | 4.18 | HTTP server |
| Prisma | 5.x | ORM |
| PostgreSQL | 15.x | Database |

## Testing

| Technology | Purpose |
|------------|---------|
| Vitest | Unit testing |
| Playwright | E2E testing |
| MSW | API mocking |

## DevOps

| Technology | Purpose |
|------------|---------|
| Docker | Containerization |
| GitHub Actions | CI/CD |
| Vercel | Deployment |

## Key Dependencies

### Production
- `@tanstack/react-query` - Server state management
- `zod` - Schema validation
- `jsonwebtoken` - JWT handling

### Development
- `eslint` - Linting
- `prettier` - Formatting
- `husky` - Git hooks

## Architecture Notes

- **Pattern**: Layered architecture (routes → services → repositories)
- **API Style**: REST with OpenAPI documentation
- **Auth**: JWT-based with refresh tokens
- **State**: React Query for server state, Zustand for client state
```

### Step 5: Generate CONCERNS.md

Analyze the codebase for potential issues:

#### Find Tech Debt Indicators

```
# TODO/FIXME comments
Grep: "(TODO|FIXME|HACK|XXX|BUG):"

# Large files (complexity indicator)
find . -name "*.ts" -exec wc -l {} + | sort -rn | head -20

# Deeply nested code
Grep: "^\s{16,}" --type ts

# Any console.log in production code
Grep: "console\.(log|debug|info)" --type ts --glob "!**/*.test.*"

# Catch-all error handlers
Grep: "catch\s*\(\s*\w*\s*\)" --type ts
```

#### Check for Common Issues

```
# Hardcoded values
Grep: "(localhost|127\.0\.0\.1|password|secret)" --type ts

# Missing error handling
Grep: "\.catch\(\s*\(\s*\)\s*=>" --type ts

# Deprecated patterns
Grep: "componentWillMount|componentWillReceiveProps" --type tsx
```

Create `CONCERNS.md`:

```markdown
# Known Concerns

> Auto-generated by Tiki on 2026-01-10. Last updated: 2026-01-10.

## Tech Debt

| Location | Issue | Severity | Notes |
|----------|-------|----------|-------|
| src/api/legacy.ts | 847 lines | Medium | Should be split into smaller modules |
| src/utils/helpers.ts | 23 TODO comments | Low | Backlog cleanup needed |
| src/services/auth.ts:45 | Hardcoded timeout | Low | Should use config |

## Security Concerns

| Location | Issue | Severity |
|----------|-------|----------|
| src/middleware/auth.ts | JWT secret from env only | Medium |
| src/api/upload.ts | No file type validation | High |

## Architecture Issues

- **Circular dependencies**: `user.ts` ↔ `team.ts` - consider extracting shared types
- **God object**: `AppContext` has 15 properties - consider splitting
- **Missing abstraction**: Database queries scattered across services

## Fragile Areas

Areas that need extra care when modifying:

| Area | Why it's fragile |
|------|------------------|
| src/hooks/useAuth.ts | Complex state machine, many dependents |
| src/api/payment.ts | Stripe integration, affects billing |
| database/migrations/ | Order-dependent, hard to rollback |

## Missing Tests

| Area | Coverage | Risk |
|------|----------|------|
| src/services/billing.ts | 0% | High - payment logic |
| src/api/admin.ts | 12% | Medium - admin functions |

## Recommendations

1. **Immediate**: Add file type validation to upload endpoint
2. **Short-term**: Split legacy.ts into domain-specific modules
3. **Long-term**: Increase test coverage for billing service
```

### Step 6: Update CLAUDE.md (Optional)

If `--update-claude` flag is present, append discovered patterns to CLAUDE.md:

```markdown
## Discovered Patterns

> Added by /tiki:map-codebase on 2026-01-10

### Code Organization
- Services are in `src/services/`
- API routes are in `src/api/`
- Shared types are in `src/types/`

### Naming Conventions
- Files: kebab-case (user-service.ts)
- Components: PascalCase (UserProfile.tsx)
- Functions: camelCase (getUserById)

### Testing
- Tests live next to source files (*.test.ts)
- Use MSW for API mocking
- E2E tests in `e2e/` folder
```

### Step 7: Display Summary

```
## Codebase Mapping Complete

### Files Generated
- STACK.md - Technology overview
- CONCERNS.md - Known issues and tech debt

### Key Findings

**Stack:**
- TypeScript + React frontend
- Express + Prisma backend
- PostgreSQL database
- Vitest + Playwright testing

**Concerns Found:**
- 3 security issues (1 high, 2 medium)
- 5 tech debt items
- 2 fragile areas identified
- 15% overall test coverage

### Recommendations
1. Review high-severity security issue in upload.ts
2. Consider splitting legacy.ts (847 lines)
3. Add tests to billing service

---
View full reports:
- `cat STACK.md`
- `cat CONCERNS.md`

Create issues from concerns? Use `/tiki:create-issues --from-concerns`
```

## Refresh Mode

Running `/tiki:map-codebase` when files already exist:

```
Existing STACK.md and CONCERNS.md found.

Options:
1. Regenerate both (overwrites existing)
2. Update only (merge new findings)
3. Show diff (compare current vs new scan)
4. Cancel

Which option? [1/2/3/4]
```

## Integration with Other Skills

- `/tiki:assess-code` - Uses STACK.md for context, generates detailed scores
- `/tiki:update-claude` - Uses discovered patterns to update CLAUDE.md
- `/tiki:create-issues` - Can create issues from CONCERNS.md findings

## Notes

- Run this skill when joining a new project
- Re-run periodically to catch new tech debt
- STACK.md helps Claude understand the project quickly
- CONCERNS.md helps prioritize work
- Files are placed in project root by default
- Respects .gitignore patterns when scanning
